# Docker Compose configuration for integration testing
#
# Purpose: Provides isolated testing environment with access to:
#   - Real Nessus scanner (via nessus_nessus_net network)
#   - Dedicated Redis instance for testing
#   - Test runner container with all dependencies
#
# Usage:
#   # Start test environment
#   docker compose -f docker-compose.test.yml up -d
#
#   # Run integration tests (real Nessus + Redis)
#   docker compose -f docker-compose.test.yml exec test-runner pytest tests/integration/test_phase0_phase1_real_nessus.py -v -s -m real_nessus
#
#   # Run lightweight tests only
#   docker compose -f docker-compose.test.yml exec test-runner pytest tests/integration/test_phase0_phase1_real_nessus.py::test_redis_connectivity_from_docker_network -v -s
#
#   # Run all Phase 0+1 tests
#   docker compose -f docker-compose.test.yml exec test-runner pytest -v -s -m "phase0 or phase1"
#
#   # Cleanup
#   docker compose -f docker-compose.test.yml down -v

version: '3.8'

services:
  # Redis instance for testing (isolated from production)
  redis-test:
    image: redis:7.4.7-alpine
    container_name: nessus-mcp-test-redis
    command: redis-server --save ""  # Disable persistence for tests
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - test-internal
      - nessus_nessus_net  # Connect to Nessus network

  # Test runner container
  test-runner:
    build:
      context: .
      dockerfile: docker/Dockerfile.test
    container_name: nessus-mcp-test-runner
    environment:
      # Redis configuration (use test instance)
      - REDIS_URL=redis://redis-test:6379

      # Nessus configuration (connect to real scanner via vpn-gateway)
      - NESSUS_URL=https://vpn-gateway:8834
      - NESSUS_USERNAME=${NESSUS_USERNAME:-nessus}
      - NESSUS_PASSWORD=${NESSUS_PASSWORD:-nessus}

      # Logging
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1

    volumes:
      # Mount entire mcp-server directory for live code changes
      - .:/app:ro

      # Mount test data directory (read-write for test artifacts)
      - test_data:/tmp/test-phase0-phase1-nessus

      # Mount venv for faster test runs (optional)
      - ../venv:/venv:ro

    depends_on:
      redis-test:
        condition: service_healthy

    # Keep container running for interactive test execution
    command: tail -f /dev/null

    networks:
      - test-internal
      - nessus_nessus_net  # Connect to Nessus network

volumes:
  test_data:
    driver: local

networks:
  # Internal network for test services
  test-internal:
    name: nessus-mcp-test-network
    driver: bridge

  # External network where Nessus scanner lives
  nessus_nessus_net:
    external: true
    name: nessus_nessus_net
