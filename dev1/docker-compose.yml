# =============================================================================
# Nessus MCP Server - Development Environment
# =============================================================================
# Version: 2.0
# Date: 2025-11-13
# Status: PROPOSED (planning phase)
#
# Changes from previous version:
# - FIXED: Network connectivity - now connects to nessus-shared_vpn_net
# - REMOVED: Hardcoded NESSUS_URL (use scanner discovery instead)
# - ADDED: Support for multiple scanners via internal bridge
#
# Scanner Access:
# - Scanner 1: https://172.30.0.3:8834 (internal bridge)
# - Scanner 2: https://172.30.0.4:8834 (internal bridge)
#
# See /home/nessus/docker/nessus-shared/NETWORK_ARCHITECTURE.md for details
# =============================================================================

services:
  redis:
    image: redis:7-alpine
    container_name: nessus-mcp-redis-dev
    ports:
      - "6379:6379"
    volumes:
      - redis_data_dev:/data
    command: redis-server --appendonly yes --maxmemory 256mb
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  mcp-api:
    build:
      context: ../mcp-server
      dockerfile: docker/Dockerfile.api
    container_name: nessus-mcp-api-dev
    ports:
      # Host port 8836 maps to container port 8000
      # MCP clients connect to: http://localhost:8836/mcp
      - "8836:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - DATA_DIR=/app/data/tasks
      - LOG_LEVEL=DEBUG
      - ENVIRONMENT=development
      # MCP Server URL for client connections inside container
      - MCP_SERVER_URL=http://mcp-api:8000/mcp
      # Scanner URLs - MCP connects via internal bridge network
      # These are the default URLs; can be overridden by scanner config
      - NESSUS_URL=https://172.30.0.3:8834
      - SCANNER_1_URL=https://172.30.0.3:8834
      - SCANNER_2_URL=https://172.30.0.4:8834
      # Default scanner credentials (can be overridden per-scanner)
      - NESSUS_USERNAME=nessus
      - NESSUS_PASSWORD=nessus
    networks:
      - default           # Internal network for Redis connectivity
      - scanner_bridge    # External network for scanner connectivity
    volumes:
      # Hot reload: mount source code for development
      # Changes to these files take effect without rebuild
      - ../mcp-server/scanners:/app/scanners
      - ../mcp-server/core:/app/core
      - ../mcp-server/schema:/app/schema
      - ../mcp-server/tools:/app/tools
      - ../mcp-server/client:/app/client
      - ../mcp-server/tests:/app/tests
      # Data persistence (writable)
      - ./data:/app/data
      # Logs (writable)
      - ./logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    # IMPORTANT: Override Dockerfile CMD
    # Uses run_server.py which starts uvicorn with SSE app directly
    # This ensures proper lifespan management and SSE transport initialization
    command: python tools/run_server.py
    restart: unless-stopped

  scanner-worker:
    build:
      context: ../mcp-server
      dockerfile: docker/Dockerfile.worker
    container_name: nessus-mcp-worker-dev
    environment:
      - REDIS_URL=redis://redis:6379
      - DATA_DIR=/app/data/tasks
      - SCANNER_CONFIG=/app/config/scanners.yaml
      - LOG_LEVEL=DEBUG
      - MAX_CONCURRENT_SCANS=3
      # Scanner URLs - Worker connects via internal bridge network
      - NESSUS_URL=https://172.30.0.3:8834
      - SCANNER_1_URL=https://172.30.0.3:8834
      - SCANNER_2_URL=https://172.30.0.4:8834
      # Default scanner credentials
      - NESSUS_USERNAME=nessus
      - NESSUS_PASSWORD=nessus
    networks:
      - default           # Internal network for Redis connectivity
      - scanner_bridge    # External network for scanner connectivity
    volumes:
      # Hot reload: mount source code for development
      - ../mcp-server/scanners:/app/scanners
      - ../mcp-server/core:/app/core
      - ../mcp-server/worker:/app/worker
      - ../mcp-server/config:/app/config
      # Data persistence (shared with mcp-api)
      - ./data:/app/data
      # Logs (writable)
      - ./logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.from_url('redis://redis:6379'); r.ping()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  redis_data_dev:
    driver: local

networks:
  # Default network for internal communication (redis, mcp-api, scanner-worker)
  default:
    driver: bridge

  # External network for Nessus scanner connectivity
  # Connects to the scanner VPN network in /home/nessus/docker/nessus-shared/
  scanner_bridge:
    external: true
    name: nessus-shared_vpn_net

# =============================================================================
# OBSOLETE CONFIGURATION (REMOVED):
# - Old network name: nessus_nessus_net (incorrect)
# - Hardcoded NESSUS_URL: https://vpn-gateway:8834 (incorrect - not accessible)
#
# CORRECT CONFIGURATION:
# - Network: nessus-shared_vpn_net (scanner bridge)
# - Scanner 1: https://172.30.0.3:8834 (internal bridge IP)
# - Scanner 2: https://172.30.0.5:8834 (internal bridge IP)
#
# See docker-compose.yml.obsolete for previous configuration
# =============================================================================
