# =============================================================================
# Nessus MCP Server - Development Environment
# =============================================================================
# Version: 2.1
# Date: 2025-11-28
# Status: PRODUCTION
#
# Network Architecture:
# - MCP services connect to scanner network via scanner_bridge
# - Static IPs prevent conflicts with scanner infrastructure
# - Container names used for service discovery (more resilient than IPs)
#
# Scanner Access (via container names):
# - Scanner 1: https://nessus-pro-1:8834
# - Scanner 2: https://nessus-pro-2:8834
#
# IP Allocation (172.30.0.0/24):
# - 172.30.0.2: vpn-gateway (scanners-infra)
# - 172.30.0.3: nessus-pro-1 (scanners-infra)
# - 172.30.0.4: nessus-pro-2 (scanners-infra)
# - 172.30.0.5: mcp-worker (this file)
# - 172.30.0.6: mcp-api (this file)
# - 172.30.0.7: debug-scanner (scanners-infra)
# - 172.30.0.8: nginx-proxy (scanners-infra)
#
# See scanners-infra/ARCHITECTURE.md for full network topology
# =============================================================================

services:
  redis:
    image: redis:7-alpine
    container_name: nessus-mcp-redis-dev
    ports:
      - "6379:6379"
    volumes:
      - redis_data_dev:/data
    command: redis-server --appendonly yes --maxmemory 256mb
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  mcp-api:
    build:
      context: ../mcp-server
      dockerfile: docker/Dockerfile.api
    container_name: nessus-mcp-api-dev
    ports:
      # Host port 8836 maps to container port 8000
      # MCP clients connect to: http://localhost:8836/mcp
      - "8836:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - DATA_DIR=/app/data/tasks
      - LOG_LEVEL=DEBUG
      - ENVIRONMENT=development
      # MCP Server URL for client connections inside container
      - MCP_SERVER_URL=http://mcp-api:8000/mcp
      # Scanner URLs - using container names (DNS) for resilience
      # Container names resolve via Docker's embedded DNS
      - NESSUS_URL=https://nessus-pro-1:8834
      - SCANNER_1_URL=https://nessus-pro-1:8834
      - SCANNER_2_URL=https://nessus-pro-2:8834
      # Default scanner credentials (can be overridden per-scanner)
      - NESSUS_USERNAME=nessus
      - NESSUS_PASSWORD=nessus
    networks:
      default:            # Internal network for Redis connectivity
      scanner_bridge:     # External network for scanner connectivity
        ipv4_address: 172.30.0.6  # Static IP to prevent conflicts
    volumes:
      # Hot reload: mount source code for development
      # Changes to these files take effect without rebuild
      - ../mcp-server/scanners:/app/scanners
      - ../mcp-server/core:/app/core
      - ../mcp-server/schema:/app/schema
      - ../mcp-server/tools:/app/tools
      - ../mcp-server/client:/app/client
      - ../mcp-server/tests:/app/tests
      # Data persistence (writable)
      - ./data:/app/data
      # Logs (writable)
      - ./logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    # IMPORTANT: Override Dockerfile CMD
    # Uses run_server.py which starts uvicorn with SSE app directly
    # This ensures proper lifespan management and SSE transport initialization
    command: python tools/run_server.py
    labels:
      - autoheal=true
    restart: unless-stopped

  scanner-worker:
    build:
      context: ../mcp-server
      dockerfile: docker/Dockerfile.worker
    container_name: nessus-mcp-worker-dev
    environment:
      - REDIS_URL=redis://redis:6379
      - DATA_DIR=/app/data/tasks
      - SCANNER_CONFIG=/app/config/scanners.yaml
      - LOG_LEVEL=DEBUG
      # Per-pool backpressure: capacity derived from scanners.yaml (max_concurrent_scans per scanner)
      # Scanner URLs - using container names (DNS) for resilience
      - NESSUS_URL=https://nessus-pro-1:8834
      - SCANNER_1_URL=https://nessus-pro-1:8834
      - SCANNER_2_URL=https://nessus-pro-2:8834
      # Default scanner credentials
      - NESSUS_USERNAME=nessus
      - NESSUS_PASSWORD=nessus
    networks:
      default:            # Internal network for Redis connectivity
      scanner_bridge:     # External network for scanner connectivity
        ipv4_address: 172.30.0.5  # Static IP to prevent conflicts
    volumes:
      # Hot reload: mount source code for development
      - ../mcp-server/scanners:/app/scanners
      - ../mcp-server/core:/app/core
      - ../mcp-server/worker:/app/worker
      - ../mcp-server/config:/app/config
      # Data persistence (shared with mcp-api)
      - ./data:/app/data
      # Logs (writable)
      - ./logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r=redis.from_url('redis://redis:6379'); r.ping()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - autoheal=true

  # ==========================================================================
  # Autoheal - Automatically restart unhealthy containers
  # ==========================================================================
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal-mcp-dev
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    network_mode: none
    restart: unless-stopped

volumes:
  redis_data_dev:
    driver: local

networks:
  # Default network for internal communication (redis, mcp-api, scanner-worker)
  default:
    driver: bridge

  # External network for Nessus scanner connectivity
  # Connects to the scanner VPN network in /home/nessus/docker/nessus-shared/
  scanner_bridge:
    external: true
    name: nessus-shared_vpn_net

# =============================================================================
# NETWORK ARCHITECTURE NOTES:
#
# Why Static IPs + Container Names?
# - Static IPs: Prevent IP conflicts when multiple compose files share a network
# - Container Names: More resilient than IPs for service-to-service communication
#
# Scanner Access Methods:
# - Container names (preferred): https://nessus-pro-1:8834
# - Static IPs (fallback):       https://172.30.0.3:8834
#
# IP Conflict Prevention:
# - All services on shared network MUST have static IPs assigned
# - Without static IP, Docker assigns next available â†’ steals infrastructure IPs
# - See header comment for full IP allocation table
# =============================================================================
